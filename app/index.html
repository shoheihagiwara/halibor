<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <!-- https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP -->
  <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'sha256-TTpDKWhMyt5FMOOIGNJsC3d0WKkarzVlGMvJBx2tub8="> -->
  <!-- <meta http-equiv="X-Content-Security-Policy" content="default-src 'self'; script-src 'sha256-TTpDKWhMyt5FMOOIGNJsC3d0WKkarzVlGMvJBx2tub8="> -->
  <title>Hello World!</title>
  <style>
    li {
      list-style-type: decimal;
    }

    li:hover {
      background-color: silver;
    }

    /* Add a black background color to the top navigation */
    .topnav {
      background-color: #333;
      overflow: hidden;
      text-align: center;
    }

    /* Style the links inside the navigation bar */
    .topnav a {
      float: left;
      color: #f2f2f2;
      text-align: center;
      padding: 14px 16px;
      text-decoration: none;
      font-size: 17px;
    }

    /* Change the color of links on hover */
    .topnav a:hover {
      background-color: #ddd;
      color: black;
    }
  </style>
</head>

<body>
  <div class="topnav">
    <a onclick="onClipboardClicked()">Clipboard</a>
    <a onclick="onTemplateClicked()">Template</a>
  </div>
  <ul id="list"></ul>

  <!-- You can also require other files to run in this process -->
  <script type="text/javascript">
    const { ipcRenderer, clipboard } = require('electron');
    const sqlite3 = require('sqlite3');
    const path = require('path');
    const { remote } = require('electron')
    const { app, Menu, MenuItem } = remote

    // this is context menu
    const contextMenu = new Menu();
    contextMenu.append(new MenuItem({ label: 'New template' }));
    contextMenu.append(new MenuItem({ label: 'Edit' }));
    contextMenu.append(new MenuItem({ type: 'separator' }));
    contextMenu.append(new MenuItem({ label: 'Delete' }));

    const appDataDirPath = app.getPath('userData');

    const db = new sqlite3.Database(path.join(appDataDirPath, 'sqlite.db'), error => {
      if (error !== null) {
        console.log(error);
      }
    });

    function selectListFromDBAndAddToList(selectQuery, optFunc) {

      console.log("SQL: ", selectQuery);

      db.serialize(() => {
        db.all(selectQuery, (error, rows) => {
          // on error
          if (error) {
            console.log(`error when selecting: SQL[${selectQuery}] Error[${error}]`);
            return;
          }

          // on success, extract id and text, and make an array
          const arrayOfIdAndText = rows.map(row => [row.id, row.text]);

          // get ul
          const ul = document.getElementById("list");
          ul.innerHTML = "";

          arrayOfIdAndText.forEach(idText => {
            let item = document.createElement('li');
            const id = idText[0];
            item.setAttribute("id", id);

            // show only the first 30 letters.
            const text = idText[1];
            const charNumInList = 30;
            item.onclick = function () { onSelectListItem(text); };
            item.textContent = text.substring(0, charNumInList) + (text.length > charNumInList ? '...' : '');

            // show more on tooltip
            const charNumInTooltip = 200;
            item.setAttribute('title', text.substring(0, charNumInTooltip))

            ul.appendChild(item);
          });

          if (optFunc) {
            optFunc()
          }
        });
      });
    }

    function onSelectListItem(text) {
      console.log(`item clicked. adding text to clipboard: [${text}]`);
      clipboard.writeText(text);
      ipcRenderer.send('close', null);
    }

    function onTemplateClicked() {

      let prepareContextMenu = () => {

        console.log("hagi: preparing context menu");

        // add event listener to show context menu for deleting and editing
        const ul = document.getElementById('list');
        for (let li of Array.from(ul.children)) {
          console.log("adding lister to li: ", li);
          li.addEventListener("contextmenu", event => {
            // pop context menu
            contextMenu.popup({ windows: remote.getCurrentWindow() })
          })
        }
      }

      console.log("hagi: before calling function");

      // make list and set eventLister to it for context menu.
      selectListFromDBAndAddToList(
        "SELECT id, text FROM template ORDER BY id ASC;",
        prepareContextMenu
      );

      console.log("hagi: after calling function");
    }

    const selectFromClipboard = "SELECT id, text FROM clipboard ORDER BY id DESC;";
    function onClipboardClicked() {
      selectListFromDBAndAddToList(selectFromClipboard);
    }

    ipcRenderer.on('clipboard', (event) => {
      selectListFromDBAndAddToList(selectFromClipboard);
    });
  </script>
</body>

</html>