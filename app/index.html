<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <!-- https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP -->
  <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'sha256-TTpDKWhMyt5FMOOIGNJsC3d0WKkarzVlGMvJBx2tub8="> -->
  <!-- <meta http-equiv="X-Content-Security-Policy" content="default-src 'self'; script-src 'sha256-TTpDKWhMyt5FMOOIGNJsC3d0WKkarzVlGMvJBx2tub8="> -->
  <title>Hello World!</title>
  <style>
    li {
      list-style-type: decimal;
    }

    li:hover {
      background-color: silver;
    }

    /* Add a black background color to the top navigation */
    .topnav {
      background-color: #333;
      overflow: hidden;
      text-align: center;
    }

    /* Style the links inside the navigation bar */
    .topnav a {
      float: left;
      color: #f2f2f2;
      text-align: center;
      padding: 14px 16px;
      text-decoration: none;
      font-size: 17px;
    }

    /* Change the color of links on hover */
    .topnav a:hover {
      background-color: #ddd;
      color: black;
    }
  </style>
</head>

<body>
  <div class="topnav">
    <a onclick="onClipboardClicked()">Clipboard</a>
    <a onclick="onTemplateClicked()">Template</a>
  </div>
  <ul id="list"></ul>

  <!-- You can also require other files to run in this process -->
  <script type="text/javascript">
    const { ipcRenderer, clipboard } = require('electron');
    const sqlite3 = require('sqlite3');
    const path = require('path');
    const app = require('electron').remote.app

    const appDataDirPath = app.getPath('userData');

    const db = new sqlite3.Database(path.join(appDataDirPath, 'sqlite.db'), error => {
      if (error !== null) {
        console.log(error);
      }
    });

    function selectListFromDBAndAddToList(selectQuery) {

      console.log("SQL: ", selectQuery);

      db.serialize(() => {
        db.all(selectQuery, (error, rows) => {
          // on error
          if (error) {
            console.log(`error when selecting: SQL[${selectQuery}] Error[${error}]`);
            return;
          }

          // on success, extract text and make an array
          const arrayOfText = rows.map(row => row.text);

          // get ul
          const ul = document.getElementById("list");
          ul.innerHTML = "";

          arrayOfText.forEach(text => {
            let item = document.createElement('li');

            // show only the first 30 letters.
            const charNumInList = 30;
            item.onclick = function () { onSelectListItem(text); };
            item.textContent = text.substring(0, charNumInList) + (text.length > charNumInList ? '...' : '');

            // show more on tooltip
            const charNumInTooltip = 200;
            item.setAttribute('title', text.substring(0, charNumInTooltip))

            ul.appendChild(item);
          });
        });
      });
    }

    function onSelectListItem(text) {
      console.log(`item clicked. adding text to clipboard: [${text}]`);
      clipboard.writeText(text);
      ipcRenderer.send('close', null);
    }

    function onTemplateClicked() {
      selectListFromDBAndAddToList("SELECT text FROM template ORDER BY id ASC;");
    }

    const selectFromClipboard = "SELECT text FROM clipboard ORDER BY id DESC;";
    function onClipboardClicked() {
      selectListFromDBAndAddToList(selectFromClipboard);
    }

    ipcRenderer.on('clipboard', (event) => {
      selectListFromDBAndAddToList(selectFromClipboard);
    });
  </script>
</body>

</html>